<!-- Faraday Penetration Test IDE &#45; Community Version -->
<!-- Copyright (C) 2013  Infobyte LLC (http://www.infobytesec.com/) -->
<!-- See the file 'doc/LICENSE' for the license information -->
<!DOCTYPE html>   
<!--[if lt IE 7 ]> <html lang="en" class="no-js ie6"> <![endif]-->
<!--[if IE 7 ]>    <html lang="en" class="no-js ie7"> <![endif]-->
<!--[if IE 8 ]>    <html lang="en" class="no-js ie8"> <![endif]-->
<!--[if IE 9 ]>    <html lang="en" class="no-js ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html lang="en" class="no-js"> <!--<![endif]-->
<head>
    <meta charset="utf-8"/>
    <!--[if IE]><![endif]-->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
    <title>Status Report | Faraday</title>
    <meta name="description" content=""/>
    <meta name="keywords" content=""/>
    <meta name="author" content=""/>

    <!-- !CSS -->
    <link rel="stylesheet" type="text/css" href="normalize.css" />
    <link rel="stylesheet" type="text/css" href="estilos.css" />
    <link rel="stylesheet" type="text/css" href="script/jquery.qtip.css" />
    <link rel="stylesheet" href="script/bootstrap.min.css">
    <link rel="stylesheet" href="script/bootstrap-theme.min.css">
    <link href="favicon.ico" rel="shortcut icon">
    <link href="favicon.ico" type="image/vnd.microsoft.icon" rel="icon" />
    <link href="images/site_preview.jpg" rel="image_src" />

    <script type="text/javascript" src="/_utils/script/jquery.js"></script>
    <script type="text/javascript" src="/_utils/script/jquery.couch.js"></script>
    <script type="text/javascript" src="script/bootstrap.min.js"></script>
    <script type="text/javascript" src="script/angular.js"></script>
    <script type="text/javascript" src="script/angular-route.js"></script>
    <script type="text/javascript" src="script/angular-selection-model.js"></script>
    <script type="text/javascript" src="script/ui-bootstrap-tpls-0.11.2.min.js"></script>
    <script type="text/javascript" src="script/jquery.qtip.js"></script>
    <script type="text/javascript" src="script/cryptojs-sha1.js"></script>
</head>

<body ng-app="status-report">
    <div id="cont">
        <div class="wrapper">
            <header class="head">
                <a href="#" class="ws-dashboard"><img class="logo" src="images/logo-faraday.png" alt="Faraday home | WS Dashboard"/></a>
            </header>
            
            <div ng-view></div>
        </div><!--!/#wrapper -->
    </div><!--!/#container -->

    <script type="text/javascript">
        $.ajaxSetup({
            async: false
        });

        var statusReport = angular.module('status-report', ['ngRoute', 'selectionModel', 'ui.bootstrap'])
            .constant("BASEURL", (function() {
                var url = window.location.origin + "/";
                return url;
            })())
            .controller('workspacesCtrl', ['$scope', 'workspacesFact', function($scope, workspacesFact) {
                workspacesFact.get(function(wss) {
                    $scope.wss = wss;
                });
            }])
            .controller('statusReportCtrl', 
                            ['$scope', '$filter', '$route', '$routeParams', '$modal', '$log', 'statusReportFact', 
                            function($scope, $filter, $route, $routeParams, $modal, $log, statusReportFact) {
                $scope.$log = $log;
                $scope.sortField = 'date';
                $scope.reverse = true;
                // load all workspaces
                statusReportFact.getWorkspaces(function(wss) {
                    $scope.workspaces = wss;
                });
                // current workspace
                $scope.workspace = $routeParams.wsId;
                // load all vulnerabilities
                $scope.vulns = statusReportFact.getVulns($scope.workspace);

                // toggles column show property
                $scope.toggleShow = function(column, show) {
                    $scope.columns[column] = !show;
                };

                // toggles sort field and order
                $scope.toggleSort = function(field) {
                    $scope.toggleSortField(field);
                    $scope.toggleReverse();
                };

                // toggles column sort field
                $scope.toggleSortField = function(field) {
                    $scope.sortField = field;
                };

                // toggle column sort order
                $scope.toggleReverse = function() {
                    $scope.reverse = !$scope.reverse;
                }
                
                // set columns to show and hide by default
                $scope.columns = {
                    "data":     true,
                    "date":     true,
                    "desc":     true,
                    "method":   false,
                    "name":     true,
                    "params":   false,
                    "path":     false,
                    "pname":    false,
                    "query":    false,
                    "request":  false,
                    "response": false,
                    "severity": true,
                    "status":   true,
                    "target":   true,
                    "web":      true,
                    "website":  false
                };

                $scope.severities = [
                    "unclassified",
                    "info",
                    "low",
                    "med",
                    "high"
                ];

                // returns scope vulns as CSV obj
                $scope.toCSV = function() {
                    var method      = "";
                    var website     = "";
                    var desc        = "";
                    var text        = "";
                    var path        = "";
                    var pname       = "";
                    var params      = "";
                    var query       = "";
                    var request     = "";
                    var response    = "";

                    var content = "\"Date\", \"Web\", \"Status\", \"Severity\", "+
                        "\"Name\", \"Target\", \"Description\", "+
                        "\"Data\", \"Method\", \"Path\", \"Param Name\", \"Params\", "+
                        "\"Query\", \"Request\", \"Response\", \"Website\" \n";
                    
                    $scope.vulns.forEach(function(v) {
                        method      = "";
                        website     = "";
                        desc        = "";
                        text        = "";
                        path        = "";
                        pname       = "";
                        params      = "";
                        query       = "";
                        request     = "";
                        response    = "";

                        if(typeof(v.desc) != "undefined")       desc    = v.desc.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                        if(typeof(v.data.text) != "undefined")  text    = v.data.text.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                        if(v.type === "VulnerabilityWeb") {
                            if(typeof(v.method) != "undefined")     method      = v.method;
                            if(typeof(v.website) != "undefined")    website     = v.website;
                            if(typeof(v.path) != "undefined")       path        = v.path.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                            if(typeof(v.pname) != "undefined")      pname       = v.pname.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                            if(typeof(v.params) != "undefined")     params      = v.params.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                            if(typeof(v.query) != "undefined")      query       = v.query.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                            if(typeof(v.request) != "undefined")    request     = v.request.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                            if(typeof(v.response) != "undefined")   response    = v.response.replace(/\n[ ]*\n/g, "").replace(/\"/g, "'");
                        }

                        content += "\""+v.date+"\","+
                            " \""+v.web+"\","+
                            " \"Vulnerable\","+
                            " \""+v.severity+"\","+
                            " \""+v.name+"\","+
                            " \""+v.target+"\","+
                            " \""+desc+"\","+
                            " \""+text+"\","+
                            " \""+method+"\","+
                            " \""+path+"\","+
                            " \""+pname+"\","+
                            " \""+params+"\","+
                            " \""+query+"\","+
                            " \""+request+"\","+
                            " \""+response+"\","+
                            " \""+website+"\""+
                            "\n";
                    });

                    var obj = {
                        "title":    "SR-" + $scope.workspace,
                        "content":  content
                    };
                    
                    return obj;
                };

                // deletes all vulns with selected == true
                $scope.remove = function() {
                    var old = $scope.vulns;
                    $scope.vulns = [];

                    old.forEach(function(v) {
                        if(v.selected) {
                            statusReportFact.removeVulns($scope.workspace, v);
                        } else {
                            $scope.vulns.push(v);
                        }
                    });
                };

                // updates all vulns with selected == true
                $scope.update = function(data) {
                    $scope.vulns = [];
                    
                    data.vulns.forEach(function(v) {
                        if(v.selected) {
                            if(typeof(data.severity) == "string") v.severity = data.severity;
                            if(typeof(data.name) != "undefined") v.name = data.name;
                            if(typeof(data.desc) != "undefined") v.desc = data.desc;
                            if(typeof(data.datatext) != "undefined") v.data.text = data.datatext;
                            if(v.web) {
                                if(typeof(data.method) != "undefined") v.method = data.method;
                                if(typeof(data.params) != "undefined") v.params = data.params;
                                if(typeof(data.path) != "undefined") v.path = data.path;
                                if(typeof(data.pname) != "undefined") v.pname = data.pname;
                                if(typeof(data.query) != "undefined") v.query = data.query;
                                if(typeof(data.request) != "undefined") v.request = data.request;
                                if(typeof(data.response) != "undefined") v.response = data.response;
                                if(typeof(data.website) != "undefined") v.website = data.website;
                            }
                    
                            statusReportFact.putVulns($scope.workspace, v, function(rev) {
                                v.rev = rev;
                            });
                            v.selected = false;
                        }
                        $scope.vulns.push(v);
                    });
                };

                // action triggered from DELETE button
                $scope.delete = function() {
                    var selected = false;
                    var i = 0;

                    $scope.vulns.forEach(function(v) {
                        if(v.selected) {
                            selected = true;
                            i++;
                        }
                    });

                    if(selected) {
                        var modal = $modal.open({
                            templateUrl: 'partials/modal-delete.html',
                            controller: 'modalDeleteCtrl',
                            size: 'lg',
                            resolve: {
                                amount: function() {
                                    return i;
                                }
                            }
                        });

                        modal.result.then(function() {
                            $scope.remove();
                        });
                    } else {
                        var modal = $modal.open({
                            templateUrl: 'partials/modal-ko.html',
                            controller: 'modalKoCtrl',
                            resolve: {
                                msg: function() {
                                    return 'No vulnerabilities were selected to delete';
                                }
                            }
                        });
                    }
                };

                // action triggered from EDIT button
                $scope.edit = function() {
                    var selected = false;

                    $scope.vulns.forEach(function(v) {
                        if(v.selected) selected = true;
                    });

                    if(selected) {
                        var modal = $modal.open({
                            templateUrl: 'partials/modal-edit.html',
                            controller: 'modalEditCtrl',
                            size: 'lg',
                            resolve: {
                                severities: function() {
                                    return $scope.severities;
                                },
                                vulns: function() {
                                    return $scope.vulns;
                                }
                            }
                        });

                        modal.result.then(function(data) {
                            $scope.update(data);
                        });
                    } else {
                        var modal = $modal.open({
                            templateUrl: 'partials/modal-ko.html',
                            controller: 'modalKoCtrl',
                            resolve: {
                                msg: function() {
                                    return 'At least one vulnerabilty must be selected in order to edit';
                                }
                            }
                        });
                    }
                };

                $scope.checkAll = function() {
                    if(!$scope.selectall) {
                        $scope.selectall = true;
                    } else {
                        $scope.selectall = false;
                    }

                    angular.forEach($filter('filter')($scope.vulns, $scope.query), function(v) {
                        v.selected = $scope.selectall;
                    });
                };
            }])
            .controller('modalDeleteCtrl', function($scope, $modalInstance, amount) {
                if(amount == 1) {
                    $scope.message = "A vulnerability will be deleted.";
                } else {
                    $scope.message = amount + " vulnerabilities will be deleted.";
                }
                $scope.message += " This action cannot be undone. Are you sure you want to proceed?";

                $scope.ok = function() {
                    $modalInstance.close();
                };

                $scope.cancel = function() {
                    $modalInstance.dismiss('cancel');
                };
            })
            .controller('modalEditCtrl', function($scope, $modalInstance, severities, vulns) {
                $scope.severities = severities;
                $scope.vulns = vulns;
                $scope.web = false;

                $scope.vulns.forEach(function(v) {
                    if(v.selected && v.type === "VulnerabilityWeb") $scope.web = true; 
                });

                $scope.isChecked = function(i) {
                    return i.selected;
                };

                $scope.ok = function() {
                    var res = {};

                    if($scope.web) { 
                        res = {
                            "datatext": $scope.datatext,
                            "desc":     $scope.desc,
                            "method":   $scope.method,
                            "name":     $scope.name, 
                            "params":   $scope.params,
                            "path":     $scope.path,
                            "pname":    $scope.pname,
                            "query":    $scope.query,
                            "request":  $scope.request,
                            "response": $scope.response,
                            "severity": $scope.severitySelection, 
                            "vulns":    $scope.vulns, 
                            "website":  $scope.website
                        };    
                    } else {
                        res = {
                            "datatext": $scope.datatext,
                            "desc":     $scope.desc,
                            "name":     $scope.name, 
                            "severity": $scope.severitySelection, 
                            "vulns":    $scope.vulns 
                        };
                    }

                    $modalInstance.close(res);
                };

                $scope.cancel = function() {
                    $modalInstance.dismiss('cancel');
                };

            })
            .controller('modalKoCtrl', function($scope, $modalInstance, msg) {
                $scope.msg = msg;

                $scope.ok = function() {
                    $modalInstance.close();
                };
            })
            .factory('workspacesFact', ['BASEURL', '$http', function(BASEURL, $http) {
                var workspacesFact = {};

                workspacesFact.get = function(callback) {

                    var url = BASEURL + "_all_dbs";
                    $http.get(url).success(function(d, s, h, c) {
                        var wss = d.filter(function(ws) {
                            return ws.search(/^_/) < 0 && ws.search("reports") < 0;
                        });
                        callback(wss);
                    });
                };

                return workspacesFact;
            }])
            .factory('statusReportFact', ['vulnsFact', 'vulnsWebFact', 'hostsFact', 'workspacesFact', function(vulnsFact, vulnsWebFact, hostsFact, wsFact) {
                var statusReportFact = {};

                statusReportFact.getVulns = function(ws) {
                    var vulns       = vulnsFact.get(ws);
                    var vulnsWeb    = vulnsWebFact.get(ws);
                    var hosts       = hostsFact.get(ws);
                    vulns.forEach(function(element, index, array) {
                        element.target = hosts[element.parent].name;
                    });
                    vulnsWeb.forEach(function(element, index, array) {
                        element.target = hosts[element.parent].name;
                    });
                    return vulnsWeb.concat(vulns);
                };

                statusReportFact.putVulns = function(ws, vuln, callback) {
                    if(vuln.web) {
                        vulnsWebFact.put(ws, vuln, callback);
                    } else {
                        vulnsFact.put(ws, vuln, callback);
                    }
                };

                statusReportFact.removeVulns = function(ws, vuln) {
                    vulnsFact.remove(ws, vuln);
                };

                statusReportFact.getWorkspaces = function(callback) {
                    wsFact.get(callback);
                };

                return statusReportFact;
            }])
            .factory('vulnsFact', ['BASEURL', '$http', 'notesFact', function(BASEURL, $http, notesFact) {
                var vulnsFact = {};

                vulnsFact.get = function(ws) {
                    var vulns = [];
                    var note = {};
                    vulns_url = BASEURL + ws +"/_design/vulns/_view/vulns";
                    // gets vulns json from couch
                    $.getJSON(vulns_url, function(data) {
                        $.each(data.rows, function(n, obj){
                            var d = new Date(0); 
                            d.setUTCSeconds(obj.value.date);
                            d = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
                            var notes = notesFact.getNotes(ws, obj.id);
                            notes.forEach(function(n) {
                                if(n.name === "data") note = n;
                            });
                            var v = {
                                "id":           obj.id,
                                "rev":          obj.value.rev,
                                "desc":         obj.value.desc,
                                "data":         note,
                                "meta":         obj.value.meta,
                                "date":         d, 
                                "name":         obj.value.name, 
                                "oid":          obj.value.oid,
                                "owned":        obj.value.owned,
                                "owner":        obj.value.owner,
                                "parent":       obj.key.substring(0, obj.key.indexOf('.')),
                                "couch_parent": obj.value.parent,
                                "refs":         obj.value.refs,
                                "severity":     obj.value.severity,
                                "type":         obj.value.type, 
                                "web":          false,
                                "selected":     false,
                                "delete":       false
                            };
                            vulns.push(v);
                        });
                    });
                    return vulns;
                }

                vulnsFact.put = function(ws, vuln, callback) {
                    var url = BASEURL + ws + "/" + vuln.id;
                    var v = {
                        "_rev":         vuln.rev,
                        "desc":         vuln.desc, 
                        "metadata":     vuln.meta,
                        "name":         vuln.name, 
                        "obj_id":       vuln.oid,
                        "owned":        vuln.owned,
                        "owner":        vuln.owner,
                        "parent":       vuln.couch_parent, 
                        "refs":         vuln.refs,
                        "severity":     vuln.severity, 
                        "type":         vuln.type
                    };
                    $http.put(url, v).success(function(d, s, h, c) {
                        callback(d.rev);
                        console.log(vuln); 
                        notesFact.putNote(ws, "data", vuln.id, vuln.data.text);
                    });
                };

                vulnsFact.remove = function(ws, vuln) {
                    var url = BASEURL + ws + "/" + vuln.id + "?rev=" + vuln.rev;
                    $http.delete(url).success(function(d, s, h, c) {
                        console.log(d);
                    });
                };

                return vulnsFact;
            }])
            .factory('vulnsWebFact', ['BASEURL', '$http', 'notesFact', function(BASEURL, $http, notesFact) {
                var vulnsWebFact = {};

                vulnsWebFact.get = function(ws) {
                    var vulns = [];
                    var note = {};
                    vulns_url = BASEURL + ws +"/_design/vulns/_view/web";
                    // gets vulns json from couch
                    $.getJSON(vulns_url, function(data) {
                        $.each(data.rows, function(n, obj){
                            var d = new Date(0); 
                            d.setUTCSeconds(obj.value.date);
                            d = d.getDate() + "/" + d.getMonth() + "/" + d.getFullYear();
                            var notes = notesFact.getNotes(ws, obj.id);
                            notes.forEach(function(n) {
                                if(n.name === "data") note = n;
                            });
                            var v = {
                                "id":           obj.id,
                                "rev":          obj.value.rev,
                                "desc":         obj.value.desc, 
                                "meta":         obj.value.meta,
                                "date":         d, 
                                "data":         note,
                                "name":         obj.value.name, 
                                "oid":          obj.value.oid,
                                "owned":        obj.value.owned,
                                "owner":        obj.value.owner,
                                "parent":       obj.key.substring(0, obj.key.indexOf('.')),
                                "couch_parent": obj.value.parent,
                                "refs":         obj.value.refs,
                                "severity":     obj.value.severity,
                                "type":         obj.value.type, 
                                "web":          true,
                                "selected":     false,
                                "delete":       false,
                                /*** specific fields of web vulns ***/
                                "method":       obj.value.method,
                                "params":       obj.value.params,
                                "path":         obj.value.path,
                                "pname":        obj.value.pname,
                                "query":        obj.value.query,
                                "request":      obj.value.request,
                                "response":     obj.value.response,
                                "website":      obj.value.website
                            };
                            vulns.push(v);
                        });
                    });
                    return vulns;
                }

                vulnsWebFact.put = function(ws, vuln, callback) {
                    var url = BASEURL + ws + "/" + vuln.id;
                    var v = {
                        "_rev":         vuln.rev,
                        "desc":         vuln.desc, 
                        "metadata":     vuln.meta,
                        "name":         vuln.name, 
                        "obj_id":       vuln.oid,
                        "owned":        vuln.owned,
                        "owner":        vuln.owner,
                        "parent":       vuln.couch_parent, 
                        "refs":         vuln.refs,
                        "severity":     vuln.severity, 
                        "type":         vuln.type,
                        /*** specific fields of web vulns ***/
                        "method":       vuln.method,
                        "params":       vuln.params,
                        "path":         vuln.path,
                        "pname":        vuln.pname,
                        "query":        vuln.query,
                        "request":      vuln.request,
                        "response":     vuln.response,
                        "website":      vuln.website
                    };
                    $http.put(url, v).success(function(d, s, h, c) {
                        callback(d.rev);
                        notesFact.putNote(ws, "data", vuln.id, vuln.data.text);
                    });
                };

                vulnsWebFact.remove = function(ws, vuln) {
                    var url = BASEURL + ws + "/" + vuln.id + "?rev=" + vuln.rev;
                    $http.delete(url).success(function(d, s, h, c) {
                        console.log(d);
                    });
                };

                return vulnsWebFact;
            }])
            .factory('hostsFact', ['BASEURL', function(BASEURL) {
                var hostsFact = {};

                hostsFact.get = function(ws) {
                    hosts_url = BASEURL + ws + "/_design/hosts/_view/hosts";
                    var hosts = [];
                    //gets hosts json from couch
                    $.getJSON(hosts_url, function(data) {
                        $.each(data.rows, function(n, obj) {
                           hosts[obj.id] = {"name": obj.value.name, "os": obj.value.os, "owned": obj.value.owned};
                        }); 
                    });
                    return hosts;
                }
                return hostsFact;
            }])
            .factory('notesFact', ['BASEURL', '$http', function(BASEURL, $http) {
                var notesFact = {};

                notesFact.getNotes = function(ws, parent) {
                    var noteIds = [];
                    var notes = [];
                    var note = {};
                    var params = JSON.stringify([parent, "Note"]);
                    var url = BASEURL + ws + "/_design/mapper/_view/byparentandtype?key=" + params;
                    $.getJSON(url, function(data) {
                        $.each(data.rows, function(n, obj) {
                            noteIds.push(obj.value);
                        });
                    });
                    noteIds.forEach(function(id) {
                        url = BASEURL + ws + "/" + id;
                        $.getJSON(url, function(data) {
                            note = {
                                "id":   data._id,
                                "rev":  data._rev,
                                "name": data.name,
                                "text": data.text
                            };
                            notes.push(note);
                        });
                    });
                    return notes;
                };

                // updates note if existing, creates otherwise
                notesFact.putNote = function(ws, name, parent, text) {
                    var notes   = notesFact.getNotes(ws, parent);
                    var note    = {};
                    var exists  = false;
                    var url     = BASEURL + ws + "/";
                    var id      = "";
                    var rev     = "";

                    // we need to check the name fits before updating
                    if(notes.length) {
                        notes.forEach(function(note) {
                            if(note.name === name) {
                                id      = note.id;
                                rev     = note.rev;
                                url     += note.id;
                                exists  = true;
                            }
                        });
                    }

                    if(!exists) {
                        // insert
                        id = parent + "." + CryptoJS.SHA1("Message").toString();
                        url += id;
                        note = {
                            "name":     name,
                            "parent":   parent,
                            "owned":    false,
                            "text":     text,
                            "type":     "Note"
                        };
                    } else {
                        // update
                        note = {
                            "_id":      id,
                            "_rev":     rev,
                            "name":     name,
                            "parent":   parent,
                            "owned":    false,
                            "text":     text,
                            "type":     "Note"
                        };
                    }

                    //$http.put(url, note).success(function(d, a, b, c) { console.log(d); });
                    $http.put(url, note);
                };

                return notesFact;
            }])
            .factory('commons', function() {
                var commons = {};

                commons.htmlentities = function(string, quote_style, charset, double_encode) {
                    var hash_map = commons.translationtable('HTML_ENTITIES', quote_style), symbol = '';
                    string = string == null ? '' : string + '';

                    if (!hash_map) {
                        return false;
                    }

                    if (quote_style && quote_style === 'ENT_QUOTES') {
                        hash_map["'"] = '&#039;';
                    }

                    if ( !! double_encode || double_encode == null) {
                        for (symbol in hash_map) {
                            if (hash_map.hasOwnProperty(symbol)) {
                                string = string.split(symbol)
                                    .join(hash_map[symbol]);
                            }
                        }
                    } else {
                        string = string.replace(/([\s\S]*?)(&(?:#\d+|#x[\da-f]+|[a-zA-Z][\da-z]*);|$)/g, function (ignore, text, entity) {
                            for (symbol in hash_map) {
                                if (hash_map.hasOwnProperty(symbol)) {
                                    text = text.split(symbol)
                                        .join(hash_map[symbol]);
                                }
                            }
                            return text + entity;
                        });
                    }
                    return string;
                };

                commons.translationtable = function(table, quote_style) {
                    var entities = {},
                        hash_map = {},
                        decimal;
                    var constMappingTable = {},
                        constMappingQuoteStyle = {};
                    var useTable = {},
                        useQuoteStyle = {};

                    // Translate arguments
                    constMappingTable[0]        = 'HTML_SPECIALCHARS';
                    constMappingTable[1]        = 'HTML_ENTITIES';
                    constMappingQuoteStyle[0]   = 'ENT_NOQUOTES';
                    constMappingQuoteStyle[2]   = 'ENT_COMPAT';
                    constMappingQuoteStyle[3]   = 'ENT_QUOTES';

                    useTable = !isNaN(table) ? constMappingTable[table] : table ? table.toUpperCase() : 'HTML_SPECIALCHARS';
                    useQuoteStyle = !isNaN(quote_style) ? constMappingQuoteStyle[quote_style] : quote_style ? quote_style.toUpperCase() :
                        'ENT_COMPAT';

                    if (useTable !== 'HTML_SPECIALCHARS' && useTable !== 'HTML_ENTITIES') {
                        throw new Error('Table: ' + useTable + ' not supported');
                    }

                    entities['38'] = '&amp;';
                    if (useTable === 'HTML_ENTITIES') {
                    entities['160'] = '&nbsp;';
                    entities['161'] = '&iexcl;';
                    entities['162'] = '&cent;';
                    entities['163'] = '&pound;';
                    entities['164'] = '&curren;';
                    entities['165'] = '&yen;';
                    entities['166'] = '&brvbar;';
                    entities['167'] = '&sect;';
                    entities['168'] = '&uml;';
                    entities['169'] = '&copy;';
                    entities['170'] = '&ordf;';
                    entities['171'] = '&laquo;';
                    entities['172'] = '&not;';
                    entities['173'] = '&shy;';
                    entities['174'] = '&reg;';
                    entities['175'] = '&macr;';
                    entities['176'] = '&deg;';
                    entities['177'] = '&plusmn;';
                    entities['178'] = '&sup2;';
                    entities['179'] = '&sup3;';
                    entities['180'] = '&acute;';
                    entities['181'] = '&micro;';
                    entities['182'] = '&para;';
                    entities['183'] = '&middot;';
                    entities['184'] = '&cedil;';
                    entities['185'] = '&sup1;';
                    entities['186'] = '&ordm;';
                    entities['187'] = '&raquo;';
                    entities['188'] = '&frac14;';
                    entities['189'] = '&frac12;';
                    entities['190'] = '&frac34;';
                    entities['191'] = '&iquest;';
                    entities['192'] = '&Agrave;';
                    entities['193'] = '&Aacute;';
                    entities['194'] = '&Acirc;';
                    entities['195'] = '&Atilde;';
                    entities['196'] = '&Auml;';
                    entities['197'] = '&Aring;';
                    entities['198'] = '&AElig;';
                    entities['199'] = '&Ccedil;';
                    entities['200'] = '&Egrave;';
                    entities['201'] = '&Eacute;';
                    entities['202'] = '&Ecirc;';
                    entities['203'] = '&Euml;';
                    entities['204'] = '&Igrave;';
                    entities['205'] = '&Iacute;';
                    entities['206'] = '&Icirc;';
                    entities['207'] = '&Iuml;';
                    entities['208'] = '&ETH;';
                    entities['209'] = '&Ntilde;';
                    entities['210'] = '&Ograve;';
                    entities['211'] = '&Oacute;';
                    entities['212'] = '&Ocirc;';
                    entities['213'] = '&Otilde;';
                    entities['214'] = '&Ouml;';
                    entities['215'] = '&times;';
                    entities['216'] = '&Oslash;';
                    entities['217'] = '&Ugrave;';
                    entities['218'] = '&Uacute;';
                    entities['219'] = '&Ucirc;';
                    entities['220'] = '&Uuml;';
                    entities['221'] = '&Yacute;';
                    entities['222'] = '&THORN;';
                    entities['223'] = '&szlig;';
                    entities['224'] = '&agrave;';
                    entities['225'] = '&aacute;';
                    entities['226'] = '&acirc;';
                    entities['227'] = '&atilde;';
                    entities['228'] = '&auml;';
                    entities['229'] = '&aring;';
                    entities['230'] = '&aelig;';
                    entities['231'] = '&ccedil;';
                    entities['232'] = '&egrave;';
                    entities['233'] = '&eacute;';
                    entities['234'] = '&ecirc;';
                    entities['235'] = '&euml;';
                    entities['236'] = '&igrave;';
                    entities['237'] = '&iacute;';
                    entities['238'] = '&icirc;';
                    entities['239'] = '&iuml;';
                    entities['240'] = '&eth;';
                    entities['241'] = '&ntilde;';
                    entities['242'] = '&ograve;';
                    entities['243'] = '&oacute;';
                    entities['244'] = '&ocirc;';
                    entities['245'] = '&otilde;';
                    entities['246'] = '&ouml;';
                    entities['247'] = '&divide;';
                    entities['248'] = '&oslash;';
                    entities['249'] = '&ugrave;';
                    entities['250'] = '&uacute;';
                    entities['251'] = '&ucirc;';
                    entities['252'] = '&uuml;';
                    entities['253'] = '&yacute;';
                    entities['254'] = '&thorn;';
                    entities['255'] = '&yuml;';
                    }

                    if (useQuoteStyle !== 'ENT_NOQUOTES') {
                        entities['34'] = '&quot;';
                    }
                    if (useQuoteStyle === 'ENT_QUOTES') {
                        entities['39'] = '&#39;';
                    }
                    entities['60'] = '&lt;';
                    entities['62'] = '&gt;';

                    // ascii decimals to real symbols
                    for (decimal in entities) {
                        if (entities.hasOwnProperty(decimal)) {
                            hash_map[String.fromCharCode(decimal)] = entities[decimal];
                        }
                    }

                    return hash_map;
                }

                return commons;
            })
            // CSV export
            .factory('$blob', function() {
              return {
                csvToURL: function(content) {
                  var blob;
                  blob = new Blob([content], {type: 'text/csv'});
                  return (window.URL || window.webkitURL).createObjectURL(blob);
                },
                sanitizeCSVName: function(name) {
                  if (/^[A-Za-z0-9]+\.csv$/.test(name)) {
                    return name;
                  }
                  if (/^[A-Za-z0-9]+/.test(name)) {
                    return name + ".csv";
                  }
                  throw new Error("Invalid title fo CSV file : " + name);
                },
                revoke: function(url) {
                  return (window.URL || window.webkitURL).revokeObjectURL(url);
                }
              };
            })
            // CSV export
            .factory('$click', function() {
              return {
                on: function(element) {
                  var e = document.createEvent("MouseEvent");
                  e.initMouseEvent("click", false, true, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                  element.dispatchEvent(e);
                }
              };
            })
            // CSV export
            .directive('downloadCsv', function($parse, $click, $blob, $log, $timeout) {
              return {
                compile: function($element, attr) {
                  var fn = $parse(attr.downloadCsv);
                   
                  return function(scope, element, attr) {
                     
                    element.on('click', function(event) {
                      var a_href, content, title, url, _ref;
                      _ref = fn(scope), content = _ref.content, title = _ref.title;
                       
                      if (!(content != null) && !(title != null)) {
                        $log.warn("Invalid content or title in download-csv : ", content, title);
                        return;
                      }
                       
                      title = $blob.sanitizeCSVName(title);
                      url = $blob.csvToURL(content);
                       
                      element.append("<a download=\"" + title + "\" href=\"" + url + "\"></a>");
                      a_href = element.find('a')[0];
                       
                      $click.on(a_href);
                      $timeout(function() {$blob.revoke(url);});
                       
                      element[0].removeChild(a_href);
                    });
                  };
                }
              };
            })
            .directive('textCollapse', ['$compile', 'commons', function($compile, commons) {
                return {
                    restrict: 'A',
                    replace: true,
                    link: function(scope, element, attrs) {
                        // start collapsed
                        scope.collapsed = false;

                        // create the function to toggle the collapse
                        scope.toggle = function() {
                            scope.collapsed = !scope.collapsed;
                        };

                        // wait for changes on the text
                        attrs.$observe('textCollapseText', function(text) {
                            // escape text
                            text = commons.htmlentities(text);

                            // and get the maxLength
                            var maxLength = scope.$eval(attrs.textCollapseMaxLength);

                            if(text.length > maxLength) {
                                // split the text in two parts, the first always showing
                                var firstPart = String(text).substring(0, maxLength);
                                var secondPart = String(text).substring(maxLength, text.length);

                                // create some new html elements to hold the separate info
                                var firstSpan = $compile('<span>' + firstPart + '</span>')(scope);
                                var secondSpan = $compile('<span ng-if="collapsed">' + secondPart + '</span>')(scope);
                                var moreIndicatorSpan = $compile('<span ng-if="!collapsed">...</span>')(scope);
                                var toggleButton = $compile('<span selection-model-ignore class="collapse-text-toggle" ng-click="toggle()"> <a href="" selection-model-ignore>{{collapsed ? "less" : "more"}}</a></span>')(scope);

                                // remove the current contents of the element
                                // and add the new ones we created
                                element.empty();
                                element.append(firstSpan);
                                element.append(secondSpan);
                                element.append(moreIndicatorSpan);
                                element.append(toggleButton);
                            } else {
                                element.empty();
                                element.append(text);
                            }
                        });
                    }
                };
            }]);
            statusReport.config(['$routeProvider', function($routeProvider) {
                $routeProvider.
                    when('/ws/:wsId', {
                        templateUrl: 'partials/status_report.html',
                        controller: 'statusReportCtrl'
                    }).
                    when('/', {
                        templateUrl: 'partials/workspaces.html',
                        controller: 'workspacesCtrl'
                    }).
                    otherwise({
                        templateUrl: 'partials/status_report.html',
                        controller: 'statusReportCtrl'
                    });
            }]);
    </script>
</body>
</html> 
